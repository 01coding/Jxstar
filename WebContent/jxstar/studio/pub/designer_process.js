/*
 * Copyright 2011 Guangzhou Donghong Software Technology Inc.
 * Licensed under the www.jxstar.org
 */
Jxstar.currentPage={layoutEl:null,parentEl:null,processId:"",compnum:0,currentComp:null,editor:null,render:function(a,h,l,b){var m=this;this.processId=a;this.layoutEl=l;var i=b.gridNode.event;var k=['<div id="mx_page" style="background-color:#ffffff;height:100%;">','<table border="0" width="90%">',"<tr>",'<td id="mx_toolbar" style="width:16px;padding-left:5px;" valign="top">',"</td>",'<td valign="top" style="border-width:1px;border-style:solid;border-color:#f7f7f7;">','<div id="mx_graph" style="position:relative;height:520px;width:100%;background-color:white;overflow:hidden;cursor:default;">','<center id="mx_splash" style="padding-top:230px;">','<img src="lib/graph/images/loading.gif">',"</center>","</div>","</td>","</tr>","</table>","</div>"];var d=l.getTopToolbar();var g=l.getComponent(0);if(g){d.removeAll(true)}else{g=new Ext.Panel({border:false,html:k.join("")});l.add(g)}l.on("beforedestroy",function(){if(Jxstar.editor){Jxstar.editor.destroy();mxClient.dispose();Jxstar.editor=null}g.removeAll(true);g.destroy();g=null;return true});var j=[{text:jx.base.del+" Del",handler:function(){m.editor.execute("delete")}},{text:jx.base.undo+" Ctrl+Z",handler:function(){m.editor.execute("undo")}},{text:jx.base.cut+" Ctrl+X",handler:function(){m.editor.execute("cut")}},{text:jx.base.copy+" Ctrl+C",handler:function(){m.editor.execute("copy")}},{text:jx.base.paste+" Ctrl+V",handler:function(){m.editor.execute("paste")}},{text:jx.wfx.group,handler:function(){m.editor.execute("group")}},{text:jx.wfx.ungroup,handler:function(){m.editor.execute("ungroup")}},{text:jx.wfx.setpic,handler:function(){m.setImagePath()}}];var e=[{text:jx.wfx.zoomin,handler:function(){m.editor.execute("zoomIn")}},{text:jx.wfx.zoomout,handler:function(){m.editor.execute("zoomOut")}},{text:jx.wfx.actual,handler:function(){m.editor.execute("actualSize")}},{text:jx.wfx.fit,handler:function(){m.editor.execute("fit")}}];var c=[{text:jx.wfx.check,iconCls:"eb_check",handler:function(){i.checkwf()}},{text:jx.wfx.del,iconCls:"eb_delete",handler:function(){m.deleteDesign()}},{text:jx.wfx.exp,iconCls:"eb_exp",handler:function(){m.exportDesign()}}];d.add({text:jx.base.save,iconCls:"eb_save",handler:function(){m.saveDesign()}},{text:jx.wfx.enable,iconCls:"eb_enable",handler:function(){i.enablewf()}},{xtype:"tbseparator"},{text:jx.wfx.extdo,iconCls:"eb_menu",menu:c},{xtype:"tbseparator"},{text:jx.wfx.prop,iconCls:"eb_prop",id:"set_attri",handler:function(){m.modifyDefine()}},{xtype:"tbfill"},{xtype:"tbseparator"},{text:jx.wfx.picdo,iconCls:"eb_menu",menu:j},{text:jx.wfx.sizedo,iconCls:"eb_menu",menu:e});l.doLayout();m.parentEl=g.el;if(Jxstar.editor==null){JxUtil.loadJxGraph();var f=new mxCanvas("lib/graph/config/editor.xml");m.editor=f;Jxstar.editor=f}else{m.editor=Jxstar.editor}m.disableDesign(h);m.readDesign()},disableDesign:function(b){var a=(b!="1");this.editor.graph.setEnabled(b!="3");this.editor.graph.setConnectable(!a);this.editor.graph.setDropEnabled(!a);this.editor.graph.setCellsDeletable(!a);this.editor.graph.setCellsMovable(!a);Ext.fly("mx_toolbar").setDisplayed(!a);var c=this.layoutEl.getTopToolbar();c.setDisabled(a);c.getComponent("set_attri").setDisabled(b=="3")},saveDesign:function(){var o=this,f=new mxCodec(),n=o.editor.graph,h=f.encode(n.getModel()),a=h.getElementsByTagName("root")[0],i=a.childNodes;var l=[],k=[],j=[],c=[];Ext.each(i,function(r,p){var e=r.getAttribute("nodetype");if(e!=null&&e.length>0){l.push(r);if(e=="task"){j.push(r)}}var q=r.getAttribute("edge");if(q!=null&&q.length>0){if(r.getAttribute("style")=="straightConnector"){c.push(r)}else{k.push(r)}}});if(!o.validDesign(l,k)){return}if(!o.validBackLines(j,c,k)){return}var b=o.paramDesign(l,k,c);var m=mxUtils.getPrettyXml(h);var g=encodeURIComponent;var d="funid=wf_process&eventcode=savedesign&pagetype=formdes&process_id="+o.processId+b+"&xmlfile="+g(m);Request.postRequest(d,null)},validDesign:function(a,c){var b=this;if(!b.validAllLine(c)){return false}if(!b.validStartNode(a,c)){return false}if(!b.validEndNode(a,c)){return false}if(!b.validTaskNode(a,c)){return false}if(!b.validSelectNode(a,c)){return false}if(!b.validForkNode(a,c)){return false}if(!b.validJoinNode(a,c)){return false}return true},paramDesign:function(p,m,c){var f="";var l=[],d=[],o=[];for(var h=0,b=p.length;h<b;h++){var s=p[h];l[h]=s.getAttribute("id");d[h]=s.getAttribute("nodetype");o[h]=s.getAttribute("value")}var a=[],r=[],g=[],q=[],j=[];var t=[];t=t.concat(m,c);for(var h=0,b=t.length;h<b;h++){var s=t[h];a[h]=s.getAttribute("id");r[h]=(s.getAttribute("style")=="straightConnector")?"1":"0";g[h]=s.getAttribute("value");q[h]=s.getAttribute("source");j[h]=s.getAttribute("target")}var k=encodeURIComponent;var f="&nodeIds="+l+"&nodeTypes="+d+"&nodeTitles="+k(o)+"&lineIds="+a+"&lineTypes="+k(r)+"&lineTitles="+k(g)+"&lineSources="+q+"&lineTargets="+j;return f},readDesign:function(){var a=this;var b=function(d){if(d==null||d.length==0){d="<?xml version='1.0' encoding='utf-8'?>";d+="<mxGraphModel><root><mxCell id='0'/><mxCell id='1' parent='0'/></root></mxGraphModel>"}var e=mxUtils.parseXml(d);var f=new mxCodec(e);f.decode(e.documentElement,a.editor.graph.getModel())};var c="funid=wf_process&eventcode=readdesign&pagetype=formdes";c+="&process_id="+a.processId;Request.dataRequest(c,b,{type:"xml",wait:true})},createDesign:function(){var b=this,f=b.editor.graph,d=f.getModel(),e=f.getDefaultParent();d.beginUpdate();try{var c=f.insertVertex(e,null,jx.wfx.start,20,20,80,40,"hexagon");var a=f.insertVertex(e,null,jx.wfx.end,30,250,40,40,"doubleEllipse")}finally{d.endUpdate()}},deleteDesign:function(){var b=this,d=b.editor.graph,c=d.getDefaultParent();var a=function(){d.selectCells(true,true,c);var f=d.getSelectionCells();d.removeCells(f,true)};var e=function(){var f="funid=wf_process&eventcode=deldesign&pagetype=formdes&process_id="+b.processId;Request.postRequest(f,a)};Ext.Msg.confirm(jx.base.hint,jx.wfx.delyes,function(f){if(f=="yes"){e()}})},exportDesign:function(){var c=this,b=new mxCodec(),e=b.encode(c.editor.graph.getModel()),a=mxUtils.getPrettyXml(e);var d=new Ext.Window({title:jx.wfx.showdes,layout:"fit",width:750,height:500,resizable:true,modal:true,closeAction:"close",items:[{xtype:"textarea",name:"wf_process__design_file",border:false,value:a,style:"font-size:13px;border-width:0;line-height:20px;",readOnly:true}]});d.show()},importDesign:function(){JxHint.alert(jx.bus.text34)},modifyDefine:function(){var k=this,j=k.editor.graph,h=j.getSelectionCell();if(h==null){JxHint.alert(jx.wfx.nopic);return}var c=h.getId();var f=new mxCodec();var d=f.encode(h);var b=d.getAttribute("nodetype");var a=d.getAttribute("source");var e=null;if(b=="task"){e=Jxstar.findNode("wf_nodeattr");e.width=750;e.height=500}else{if(b=="join"){e=Jxstar.findNode("wf_nodeattr1");e.width=550;e.height=250}else{if(b=="subprocess"){e=Jxstar.findNode("wf_subprocess");e.width=450;e.height=200}else{if(a!=null&&a.length>0){var g=k.findNode(a);var i=g.getAttribute("nodetype");if(i!="select"&&i!="fork"){JxHint.alert(jx.wfx.tip01);return}e=Jxstar.findNode("wf_condition");e.width=550;e.height=250}else{JxHint.alert(jx.wfx.tip02);return}}}}k.setProcessAttr(c,k.processId,e)},setProcessAttr:function(d,g,h){var f=h.nodeid;var c=h.tablename;var b=(c=="wf_condition")?"line_id":"node_id";var e=function(i){JxUtil.delay(500,function(){if(f=="wf_nodeattr"){i=i.getComponent(0).getComponent(0)}var j={where_sql:c+"."+b+" = ? and "+c+".process_id = ?",where_type:"string;string",where_value:d+";"+g,callback:function(l){if(l.length==0){i.formNode.event.create();i.getForm().set(c+"__"+b,d);i.getForm().set(c+"__process_id",g)}else{var k=i.formNode.event.newRecord(l[0]);i.getForm().myRecord=k;i.getForm().loadRecord(k)}}};Jxstar.queryData(f,j)})};var a=(f=="wf_nodeattr")?h.layout:h.formpage;Jxstar.showData({filename:a,title:h.nodetitle,width:h.width,height:h.height,nodedefine:h,callback:e})},setImagePath:function(){var a=this;graph=a.editor.graph;curCell=graph.getSelectionCell();if(curCell==null){JxHint.alert(jx.wfx.nopic);return}var b=curCell.getStyle();if(b.indexOf("image")!=0){JxHint.alert(jx.wfx.tip03);return}var c=function(d){graph.setCellStyles("image",d,[curCell])};Ext.Msg.prompt(jx.wfx.picname,jx.wfx.defval+": lib/graph/images/dude.png",function(d,e){if(d!="ok"){return}if(e.length==0){JxHint.alert(jx.wfx.tip04);return}if(e.charAt(0)=="/"){e=e.substring(1)}c(e)})},validAllLine:function(h){var b=this;for(var d=0,g=h.length;d<g;d++){var e=h[d];var a=e.getAttribute("id");var f=e.getAttribute("source");if(f==null||f.length==0){b.focusNode(a);JxHint.alert(jx.wfx.tip05);return false}var c=e.getAttribute("target");if(c==null||c.length==0){b.focusNode(a);JxHint.alert(jx.wfx.tip06);return false}}return true},validBackLines:function(r,g,q){if(g.length==0){return true}var s=this;for(var l=0,c=g.length;l<c;l++){var t=g[l];var p=t.getAttribute("id");var a=t.getAttribute("source");var f=t.getAttribute("target");var o,k;for(var h=0,e=r.length;h<e;h++){var d=r[h];var b=d.getAttribute("id");if(a==b){o=d}if(f==b){k=d}}if(o==null){s.focusNode(p);JxHint.alert(jx.wfx.tip07);return false}if(k==null){s.focusNode(p);JxHint.alert(jx.wfx.tip08);return false}if(s.findPreForkNode(f,q)){s.focusNode(p);JxHint.alert(jx.wfx.tip09);return false}if(s.findPreForkNode(a,q)){s.focusNode(p);JxHint.alert(jx.wfx.tip10);return false}}return true},validStartNode:function(b,f){var c=this;var d=0,a="";Ext.each(b,function(h){var g=h.getAttribute("nodetype");if(g=="start"){d++;a=h.getAttribute("id")}});if(d!=1){JxHint.alert(jx.wfx.tip11);return false}var e=c.nodeLineNums(a,f);if(e.outNum!=1){c.focusNode(a);JxHint.alert(jx.wfx.tip12);return false}if(e.inNum!=0){c.focusNode(a);JxHint.alert(jx.wfx.tip13);return false}return true},validEndNode:function(a,h){var b=this;var d=0,f=[];Ext.each(a,function(j){var i=j.getAttribute("nodetype");if(i=="end"){d++;f.push(j.getAttribute("id"))}});if(d!=1){JxHint.alert(jx.wfx.tip14);return false}for(var c=0,g=f.length;c<g;c++){var e=b.nodeLineNums(f[c],h);if(e.outNum!=0){b.focusNode(f[c]);JxHint.alert(jx.wfx.tip15);return false}if(e.inNum==0){b.focusNode(f[c]);JxHint.alert(jx.wfx.tip16);return false}}return true},validTaskNode:function(a,h){var b=this;var d=0,f=[];Ext.each(a,function(j){var i=j.getAttribute("nodetype");if(i=="task"||i=="subprocess"){d++;f.push(j.getAttribute("id"))}});if(d==0){JxHint.alert(jx.wfx.tip17);return false}for(var c=0,g=f.length;c<g;c++){var e=b.nodeLineNums(f[c],h);if(e.outNum!=1){b.focusNode(f[c]);JxHint.alert(jx.wfx.tip18);return false}if(e.inNum==0){b.focusNode(f[c]);JxHint.alert(jx.wfx.tip19);return false}}return true},validSelectNode:function(a,g){var b=this,d=[];Ext.each(a,function(i){var h=i.getAttribute("nodetype");if(h=="select"){d.push(i.getAttribute("id"))}});for(var c=0,f=d.length;c<f;c++){var e=b.nodeLineNums(d[c],g);if(e.outNum<=1){b.focusNode(d[c]);JxHint.alert(jx.wfx.tip20);return false}if(e.inNum==0){b.focusNode(d[c]);JxHint.alert(jx.wfx.tip21);return false}}return true},validForkNode:function(a,g){var b=this,d=[];Ext.each(a,function(i){var h=i.getAttribute("nodetype");if(h=="fork"){d.push(i.getAttribute("id"))}});for(var c=0,f=d.length;c<f;c++){var e=b.nodeLineNums(d[c],g);if(e.outNum<=1){b.focusNode(d[c]);JxHint.alert(jx.wfx.tip22);return false}if(e.inNum==0){b.focusNode(d[c]);JxHint.alert(jx.wfx.tip23);return false}b.tmpNode=null;if(!b.validForkHasJoin(d[c],g)){b.focusNode(d[c]);JxHint.alert(jx.wfx.tip24);return false}}return true},validJoinNode:function(a,g){var b=this,d=[];Ext.each(a,function(i){var h=i.getAttribute("nodetype");if(h=="join"){d.push(i.getAttribute("id"))}});for(var c=0,f=d.length;c<f;c++){var e=b.nodeLineNums(d[c],g);if(e.outNum!=1){b.focusNode(d[c]);JxHint.alert(jx.wfx.tip25);return false}if(e.inNum<=1){b.focusNode(d[c]);JxHint.alert(jx.wfx.tip26);return false}b.tmpNode=null;if(!b.validJoinHasFork(d[c],g)){b.focusNode(d[c]);JxHint.alert(jx.wfx.tip27);return false}}return true},nodeLineNums:function(c,d){var b=0,a=0;Ext.each(d,function(e){var f=e.getAttribute("source");var g=e.getAttribute("target");if(f==c){a++}if(g==c){b++}});return{inNum:b,outNum:a}},validForkHasJoin:function(c,g){var j=this;var k=j.findOutLines(c,g);for(var e=0,b=k.length;e<b;e++){var h=k[e].getAttribute("target");var f=j.findNode(h);var a=f.getAttribute("nodetype");var d=f.getAttribute("value");if(a=="end"){return false}else{if(a=="join"){if(j.tmpNode==null){j.tmpNode=h}else{if(j.tmpNode!=h){return false}}}else{if(!j.validForkHasJoin(h,g)){return false}}}}return true},validJoinHasFork:function(b,e){var j=this;var k=j.findInLines(b,e);for(var d=0,a=k.length;d<a;d++){var h=k[d].getAttribute("source");var c=j.findNode(h);var f=c.getAttribute("nodetype");var g=c.getAttribute("value");if(f=="start"){return false}else{if(f=="fork"){if(j.tmpNode==null){j.tmpNode=h}else{if(j.tmpNode!=h){return false}}}else{if(!j.validJoinHasFork(h,e)){return false}}}}return true},findOutLines:function(a,b){return this.findLines(a,b,"source")},findInLines:function(a,b){return this.findLines(a,b,"target")},findLines:function(f,h,a){var b=[];for(var c=0,g=h.length;c<g;c++){var d=h[c];var e=d.getAttribute(a);if(e==f){b.push(d)}}return b},findNode:function(d){var c=this.editor.graph;var a=c.getModel().getCell(d);var b=new mxCodec();return b.encode(a)},focusNode:function(c){var b=this.editor.graph;var a=b.getModel().getCell(c);b.setSelectionCell(a)},findPreForkNode:function(f,g){var c=this;var e=c.findInLines(f,g);if(e==null||e.length==0){return false}var a=e[0].getAttribute("source");var d=c.findNode(a);var b=d.getAttribute("nodetype");if(b=="fork"){return true}else{c.findPreForkNode(a,g)}return false}};